<html>
  <head>
    <title>
      Chunk tester
    </title>
  </head>
  <body>
    <div id="insert_here">
    </div>
    <script type="text/javascript">
      var results = {};
      var lengths = {};
      var gxhr; 
      var TestSize = function(BytesPerChunk, WhenDone) {
        var count = 0;
        var xhr = new XMLHttpRequest();
        gxhr = xhr;
        var handler = function() {
          var key = "bytes" + BytesPerChunk;
          if(xhr.readyState == 3) {
            count++;
            if(lengths[key] === undefined)
              lengths[key] = [];
            lengths[key].push(xhr.responseText.length);
          } 
          if(xhr.readyState == 4) {
            results[key] = count;
                      WhenDone();
          }
        };
        xhr.onreadystatechange = handler;
        xhr.open("GET", "/initial_chunk/" + BytesPerChunk);
        xhr.send();
      };

      var sizeStart = 16;
      var sizeEnd = 8192;
      var size = sizeStart / 2;
      var DoNext = function() {
        if(size == sizeEnd)
          return;
        size *= 2;
        TestSize(size, DoNext);
      };
      DoNext(); 
    </script>
  </body>
</html>
